{% extends "base.html" %}

{% block title %}{{ pathway_name }} Analysis - KinoPlex{% endblock %}

{% block extra_css %}
<style>
    /* Analysis Layout */
    .analysis-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .analysis-header {
        background: var(--glass-bg);
        border-radius: 20px;
        padding: 3rem;
        margin-bottom: 3rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .pathway-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .pathway-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    /* Interactive Controls */
    .controls-panel {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
    }

    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        align-items: center;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .control-label {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .control-value {
        color: var(--accent-blue);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
    }

    .slider-container {
        position: relative;
    }

    .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent-blue);
        cursor: pointer;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent-blue);
        cursor: pointer;
        border: none;
    }

    /* View Switcher */
    .view-switcher {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .view-tab {
        padding: 0.75rem 2rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition-smooth);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .view-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .view-tab.active {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }

    /* Summary Stats */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: var(--transition-smooth);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-elevated);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .chart-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--text-primary);
    }

    /* Protein Cards */
    .proteins-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 2rem;
    }

    .protein-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        transition: var(--transition-smooth);
    }

    .protein-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .protein-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .protein-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .protein-stat {
        text-align: center;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .protein-stat .number {
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Protein Linear View */
    .protein-sequence {
        position: relative;
        height: 120px;
        margin: 2rem 0;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        overflow: hidden;
    }

    .sequence-backbone {
        position: absolute;
        top: 50%;
        left: 5%;
        right: 5%;
        height: 8px;
        background: var(--gradient-secondary);
        border-radius: 4px;
        transform: translateY(-50%);
    }

    .phospho-site {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: var(--transition-smooth);
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .phospho-site:hover {
        transform: translateY(-50%) scale(1.8);
        z-index: 10;
    }

    .phospho-site.high-confidence { background: var(--accent-green); }
    .phospho-site.medium-confidence { background: var(--accent-orange); }
    .phospho-site.low-confidence { background: var(--accent-pink); }

    .phospho-site.significant {
        border-width: 3px;
        border-color: var(--accent-blue);
    }

    /* Sites Table */
    .sites-table-container {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        overflow-x: auto;
    }

    .sites-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sites-table th,
    .sites-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .sites-table th {
        background: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .sites-table th:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .sites-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .kinase-scores {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .kinase-score {
        background: var(--gradient-accent);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Kinase Cards */
    .kinases-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    .kinase-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        transition: var(--transition-smooth);
    }

    .kinase-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent-blue);
    }

    .kinase-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 1rem;
    }

    .kinase-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
    }

    .kinase-stat {
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .kinase-stat .number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .kinase-stat .label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }

    /* Loading and Empty States */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem;
        color: var(--text-secondary);
    }

    .loading-spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-blue);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 2rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .proteins-grid {
            grid-template-columns: 1fr;
        }

        .controls-grid {
            grid-template-columns: 1fr;
        }

        .view-switcher {
            flex-direction: column;
        }

        .protein-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
        <div class="loading-spinner-large"></div>
        <h3>Analyzing Pathway Phosphoproteome</h3>
        <p>Computing kinase enrichment and site statistics...</p>
    </div>

    <!-- Main Analysis Content -->
    <div id="analysis-content" style="display: none;">
        <!-- Header Section -->
        <div class="analysis-header">
            <div class="pathway-collection-badge" id="pathway-collection"></div>
            <h1 class="pathway-title" id="pathway-title">Pathway Analysis</h1>
            <p class="pathway-subtitle" id="pathway-description"></p>
        </div>

        <!-- Interactive Controls -->
        <div class="controls-panel">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">
                <i class="fas fa-sliders-h"></i> Interactive Filtering
            </h3>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        Confidence Threshold
                        <span class="control-value" id="confidence-value">0.5</span>
                    </div>
                    <input type="range" id="confidence-slider" class="slider"
                           min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        Q-value Threshold
                        <span class="control-value" id="qvalue-value">0.05</span>
                    </div>
                    <input type="range" id="qvalue-slider" class="slider"
                           min="0.001" max="0.1" step="0.001" value="0.05">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        Residue Type
                        <span class="control-value" id="residue-count">All</span>
                    </div>
                    <select id="residue-filter" class="form-select">
                        <option value="all">All Residues</option>
                        <option value="S">Serine (S)</option>
                        <option value="T">Threonine (T)</option>
                        <option value="Y">Tyrosine (Y)</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="btn btn-primary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- View Switcher -->
        <div class="view-switcher">
            <div class="view-tab active" data-view="overview" onclick="switchView('overview')">
                <i class="fas fa-chart-pie"></i> Overview
            </div>
            <div class="view-tab" data-view="proteins" onclick="switchView('proteins')">
                <i class="fas fa-dna"></i> Protein-Level
            </div>
            <div class="view-tab" data-view="sites" onclick="switchView('sites')">
                <i class="fas fa-dot-circle"></i> Site-Level
            </div>
            <div class="view-tab" data-view="kinases" onclick="switchView('kinases')">
                <i class="fas fa-cogs"></i> Kinase-Centric
            </div>
        </div>

        <!-- Summary Statistics (Always Visible) -->
        <div class="summary-stats" id="summary-stats">
            <!-- Stats will be populated here -->
        </div>

        <!-- Overview View -->
        <div class="view-content" id="overview-view">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Confidence Distribution</h3>
                    <canvas id="confidence-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Residue Type Distribution</h3>
                    <canvas id="residue-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Secondary Structure Context</h3>
                    <canvas id="structure-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Top Enriched Kinases</h3>
                    <canvas id="kinase-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Protein-Level View -->
        <div class="view-content" id="proteins-view" style="display: none;">
            <div class="proteins-grid" id="proteins-grid">
                <!-- Protein cards will be populated here -->
            </div>
        </div>

        <!-- Site-Level View -->
        <div class="view-content" id="sites-view" style="display: none;">
            <div class="sites-table-container">
                <h3 class="chart-title">All Phosphorylation Sites</h3>
                <table class="sites-table" id="sites-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Site ID <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(1)">Protein <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(2)">Position <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(3)">Type <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(4)">Confidence <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(5)">Q-value <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(6)">Structure <i class="fas fa-sort"></i></th>
                            <th>Top Kinases</th>
                        </tr>
                    </thead>
                    <tbody id="sites-table-body">
                        <!-- Sites will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Kinase-Centric View -->
        <div class="view-content" id="kinases-view" style="display: none;">
            <div class="kinases-grid" id="kinases-grid">
                <!-- Kinase cards will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class AdvancedPathwayAnalysis {
        constructor(pathwayId) {
            this.pathwayId = pathwayId;
            this.analysisData = null;
            this.filteredData = null;
            this.charts = {};
            this.currentView = 'overview';

            this.filters = {
                confidence: 0.5,
                qvalue: 0.05,
                residueType: 'all'
            };

            this.init();
        }

        async init() {
            await this.loadAnalysisData();
            if (this.analysisData) {
                this.setupEventListeners();
                this.applyFilters();
                this.renderAnalysis();
            }
        }

        async loadAnalysisData() {
            try {
                const response = await fetch(`/api/pathway/${this.pathwayId}/analysis`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                this.analysisData = await response.json();

                if (this.analysisData.error) {
                    throw new Error(this.analysisData.error);
                }

                console.log('Analysis data loaded:', this.analysisData);
            } catch (error) {
                console.error('Error loading analysis:', error);
                this.showError(error.message);
            }
        }

        setupEventListeners() {
            // Confidence slider
            const confidenceSlider = document.getElementById('confidence-slider');
            confidenceSlider.addEventListener('input', (e) => {
                this.filters.confidence = parseFloat(e.target.value);
                document.getElementById('confidence-value').textContent = e.target.value;
                this.applyFilters();
            });

            // Q-value slider
            const qvalueSlider = document.getElementById('qvalue-slider');
            qvalueSlider.addEventListener('input', (e) => {
                this.filters.qvalue = parseFloat(e.target.value);
                document.getElementById('qvalue-value').textContent = e.target.value;
                this.applyFilters();
            });

            // Residue filter
            document.getElementById('residue-filter').addEventListener('change', (e) => {
                this.filters.residueType = e.target.value;
                this.applyFilters();
            });
        }

        applyFilters() {
            if (!this.analysisData) return;

            // Filter all sites based on current criteria
            this.filteredData = {
                ...this.analysisData,
                all_sites: this.analysisData.all_sites.filter(site => {
                    const conf = site.predicted_prob_calibrated || 0;
                    const qval = site.qvalue || 1;
                    const residue = site.residue_type;

                    if (conf < this.filters.confidence) return false;
                    if (qval > this.filters.qvalue) return false;
                    if (this.filters.residueType !== 'all' && residue !== this.filters.residueType) return false;

                    return true;
                }),
                proteins: this.analysisData.proteins.map(protein => ({
                    ...protein,
                    sites: protein.sites.filter(site => {
                        const conf = site.predicted_prob_calibrated || 0;
                        const qval = site.qvalue || 1;
                        const residue = site.residue_type;

                        if (conf < this.filters.confidence) return false;
                        if (qval > this.filters.qvalue) return false;
                        if (this.filters.residueType !== 'all' && residue !== this.filters.residueType) return false;

                        return true;
                    })
                })).filter(protein => protein.sites.length > 0)
            };

            // Update statistics
            this.updateFilteredStats();
            this.renderCurrentView();
        }

        updateFilteredStats() {
            const sites = this.filteredData.all_sites;

            const stats = {
                total_proteins: this.filteredData.proteins.length,
                total_sites: sites.length,
                significant_sites: sites.filter(s => s.significant_fdr05).length,
                high_confidence_sites: sites.filter(s => (s.predicted_prob_calibrated || 0) > 0.8).length,
                avg_confidence: sites.length > 0 ? sites.reduce((sum, s) => sum + (s.predicted_prob_calibrated || 0), 0) / sites.length : 0,
                serine_sites: sites.filter(s => s.residue_type === 'S').length,
                threonine_sites: sites.filter(s => s.residue_type === 'T').length,
                tyrosine_sites: sites.filter(s => s.residue_type === 'Y').length
            };

            // Structural features
            const validSites = sites.filter(s => s.plddt !== null && s.plddt !== undefined);
            const sasaSites = sites.filter(s => s.sasa_ratio !== null && s.sasa_ratio !== undefined);
            const disorderSites = sites.filter(s => s.disorder_score !== null && s.disorder_score !== undefined);

            const structuralStats = {
                avg_plddt: validSites.length > 0 ? validSites.reduce((sum, s) => sum + s.plddt, 0) / validSites.length : 0,
                avg_sasa_ratio: sasaSites.length > 0 ? sasaSites.reduce((sum, s) => sum + s.sasa_ratio, 0) / sasaSites.length : 0,
                avg_disorder: disorderSites.length > 0 ? disorderSites.reduce((sum, s) => sum + s.disorder_score, 0) / disorderSites.length : 0
            };

            this.filteredData.pathway_stats = stats;
            this.filteredData.structural_stats = structuralStats;

            this.updateSummaryStats();
        }

        renderAnalysis() {
            // Hide loading, show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';

            // Populate header
            this.populateHeader();

            // Render all views
            this.renderCurrentView();
        }

        populateHeader() {
            const { pathway } = this.analysisData;

            document.getElementById('pathway-collection').textContent = pathway.gs_collection;
            document.getElementById('pathway-title').textContent = pathway.gs_name;
            document.getElementById('pathway-description').textContent =
                pathway.gs_description || 'Comprehensive phosphoproteomics analysis';
        }

        updateSummaryStats() {
            const { pathway_stats, structural_stats } = this.filteredData;

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.total_proteins)}</div>
                    <div class="stat-label">Proteins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.total_sites)}</div>
                    <div class="stat-label">Filtered Sites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.significant_sites)}</div>
                    <div class="stat-label">Significant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(pathway_stats.avg_confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${structural_stats.avg_plddt.toFixed(0)}</div>
                    <div class="stat-label">Avg pLDDT</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(structural_stats.avg_sasa_ratio * 100).toFixed(0)}%</div>
                    <div class="stat-label">Avg SASA</div>
                </div>
            `;
        }

        renderCurrentView() {
            switch (this.currentView) {
                case 'overview':
                    this.renderOverviewCharts();
                    break;
                case 'proteins':
                    this.renderProteinCards();
                    break;
                case 'sites':
                    this.renderSitesTable();
                    break;
                case 'kinases':
                    this.renderKinasesGrid();
                    break;
            }
        }

        renderOverviewCharts() {
            this.createConfidenceChart();
            this.createResidueChart();
            this.createStructureChart();
            this.createKinaseChart();
        }

        createConfidenceChart() {
            const ctx = document.getElementById('confidence-chart')?.getContext('2d');
            if (!ctx) return;

            const sites = this.filteredData.all_sites;
            const bins = [0, 0, 0, 0, 0]; // 0-0.2, 0.2-0.4, 0.4-0.6, 0.6-0.8, 0.8-1.0

            sites.forEach(site => {
                const conf = site.predicted_prob_calibrated || 0;
                if (conf < 0.2) bins[0]++;
                else if (conf < 0.4) bins[1]++;
                else if (conf < 0.6) bins[2]++;
                else if (conf < 0.8) bins[3]++;
                else bins[4]++;
            });

            if (this.charts.confidence) {
                this.charts.confidence.destroy();
            }

            this.charts.confidence = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-0.2', '0.2-0.4', '0.4-0.6', '0.6-0.8', '0.8-1.0'],
                    datasets: [{
                        label: 'Site Count',
                        data: bins,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        createResidueChart() {
            const ctx = document.getElementById('residue-chart')?.getContext('2d');
            if (!ctx) return;

            const { pathway_stats } = this.filteredData;

            if (this.charts.residue) {
                this.charts.residue.destroy();
            }

            this.charts.residue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Serine (S)', 'Threonine (T)', 'Tyrosine (Y)'],
                    datasets: [{
                        data: [pathway_stats.serine_sites, pathway_stats.threonine_sites, pathway_stats.tyrosine_sites],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#8b9dc3', font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        createStructureChart() {
            const ctx = document.getElementById('structure-chart')?.getContext('2d');
            if (!ctx) return;

            const sites = this.filteredData.all_sites;
            const structures = { 'H': 0, 'E': 0, 'C': 0, 'Unknown': 0 };

            sites.forEach(site => {
                const struct = site.secondary_structure || 'Unknown';
                structures[struct] = (structures[struct] || 0) + 1;
            });

            if (this.charts.structure) {
                this.charts.structure.destroy();
            }

            this.charts.structure = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: ['Helix (H)', 'Strand (E)', 'Coil (C)', 'Unknown'],
                    datasets: [{
                        data: [structures.H, structures.E, structures.C, structures.Unknown],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#8b9dc3', font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        createKinaseChart() {
            const ctx = document.getElementById('kinase-chart')?.getContext('2d');
            if (!ctx) return;

            // Calculate kinase enrichment from filtered data
            const kinaseData = {};
            this.filteredData.all_sites.forEach(site => {
                if (site.top_kinases) {
                    site.top_kinases.forEach(k => {
                        if (!kinaseData[k.kinase]) {
                            kinaseData[k.kinase] = 0;
                        }
                        kinaseData[k.kinase]++;
                    });
                }
            });

            const topKinases = Object.entries(kinaseData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (this.charts.kinase) {
                this.charts.kinase.destroy();
            }

            this.charts.kinase = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topKinases.map(k => k[0]),
                    datasets: [{
                        label: 'Site Count',
                        data: topKinases.map(k => k[1]),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3', font: { family: 'JetBrains Mono' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        renderProteinCards() {
            const { proteins } = this.filteredData;
            const proteinsGrid = document.getElementById('proteins-grid');

            proteinsGrid.innerHTML = proteins.map(protein => {
                const maxPosition = Math.max(...protein.sites.map(s => s.position));

                return `
                    <div class="protein-card">
                        <div class="protein-header">
                            <h3 class="protein-name">${protein.gene_symbol}</h3>
                            <div class="protein-stats">
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.sites.length)}</div>
                                    <div>Sites</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.sites.filter(s => s.significant_fdr05).length)}</div>
                                    <div>Significant</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.sites.filter(s => (s.predicted_prob_calibrated || 0) > 0.8).length)}</div>
                                    <div>High Conf.</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${((protein.sites.reduce((sum, s) => sum + (s.predicted_prob_calibrated || 0), 0) / protein.sites.length) * 100).toFixed(0)}%</div>
                                    <div>Avg Conf.</div>
                                </div>
                            </div>
                        </div>

                        <div class="protein-sequence">
                            <div class="sequence-backbone"></div>
                            ${protein.sites.map((site, index) => {
                                const leftPercent = 5 + (site.position / maxPosition) * 90;
                                const confidence = site.predicted_prob_calibrated || 0;
                                const confidenceClass = confidence > 0.8 ? 'high-confidence' :
                                                      confidence > 0.5 ? 'medium-confidence' : 'low-confidence';
                                const significantClass = site.significant_fdr05 ? 'significant' : '';

                                return `
                                    <div class="phospho-site ${confidenceClass} ${significantClass}"
                                         style="left: ${leftPercent}%"
                                         title="${site.gene_symbol} ${site.residue_type}${site.position} - Confidence: ${(confidence * 100).toFixed(1)}% - Top kinases: ${site.top_kinases ? site.top_kinases.map(k => k.kinase).join(', ') : 'N/A'}"
                                         onclick="this.classList.toggle('selected')">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        renderSitesTable() {
            const sites = this.filteredData.all_sites.slice().sort((a, b) => (b.predicted_prob_calibrated || 0) - (a.predicted_prob_calibrated || 0));

            const tbody = document.getElementById('sites-table-body');
            tbody.innerHTML = sites.map(site => `
                <tr>
                    <td><code>${site.site_id}</code></td>
                    <td><strong>${site.gene_symbol}</strong></td>
                    <td>${site.position}</td>
                    <td><span style="font-family: monospace;">${site.residue_type}</span></td>
                    <td>${((site.predicted_prob_calibrated || 0) * 100).toFixed(1)}%</td>
                    <td>${site.qvalue ? site.qvalue.toExponential(2) : 'N/A'}</td>
                    <td>${site.secondary_structure || 'N/A'}</td>
                    <td>
                        <div class="kinase-scores">
                            ${site.top_kinases ? site.top_kinases.slice(0, 3).map(k =>
                                `<div class="kinase-score">${k.kinase}: ${k.score.toFixed(3)}</div>`
                            ).join('') : 'N/A'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        renderKinasesGrid() {
            // Calculate kinase statistics from filtered data
            const kinaseStats = {};

            this.filteredData.all_sites.forEach(site => {
                if (site.top_kinases) {
                    site.top_kinases.forEach(k => {
                        if (!kinaseStats[k.kinase]) {
                            kinaseStats[k.kinase] = {
                                kinase: k.kinase,
                                site_count: 0,
                                protein_count: 0,
                                proteins: new Set(),
                                avg_score: 0,
                                max_score: 0,
                                scores: []
                            };
                        }

                        kinaseStats[k.kinase].site_count++;
                        kinaseStats[k.kinase].proteins.add(site.gene_symbol);
                        kinaseStats[k.kinase].scores.push(k.score);
                    });
                }
            });

            // Calculate final statistics and convert to array
            const kinases = Object.values(kinaseStats).map(k => {
                k.protein_count = k.proteins.size;
                k.avg_score = k.scores.reduce((sum, s) => sum + s, 0) / k.scores.length;
                k.max_score = Math.max(...k.scores);
                delete k.proteins; // Remove Set object
                delete k.scores; // Remove scores array
                return k;
            }).sort((a, b) => b.site_count - a.site_count);

            const kinasesGrid = document.getElementById('kinases-grid');
            kinasesGrid.innerHTML = kinases.map(kinase => `
                <div class="kinase-card">
                    <div class="kinase-name">${kinase.kinase}</div>
                    <div class="kinase-stats">
                        <div class="kinase-stat">
                            <div class="number">${this.formatNumber(kinase.site_count)}</div>
                            <div class="label">Sites</div>
                        </div>
                        <div class="kinase-stat">
                            <div class="number">${this.formatNumber(kinase.protein_count)}</div>
                            <div class="label">Proteins</div>
                        </div>
                        <div class="kinase-stat">
                            <div class="number">${kinase.avg_score.toFixed(3)}</div>
                            <div class="label">Avg Score</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Analysis Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // View switching functionality
    function switchView(viewName) {
        pathwayAnalysis.currentView = viewName;

        // Update active tab
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

        // Show/hide view content
        document.querySelectorAll('.view-content').forEach(view => {
            view.style.display = 'none';
        });
        document.getElementById(`${viewName}-view`).style.display = 'block';

        // Render current view
        pathwayAnalysis.renderCurrentView();
    }

    function resetFilters() {
        document.getElementById('confidence-slider').value = '0.5';
        document.getElementById('qvalue-slider').value = '0.05';
        document.getElementById('residue-filter').value = 'all';

        pathwayAnalysis.filters = {
            confidence: 0.5,
            qvalue: 0.05,
            residueType: 'all'
        };

        document.getElementById('confidence-value').textContent = '0.5';
        document.getElementById('qvalue-value').textContent = '0.05';
        document.getElementById('residue-count').textContent = 'All';

        pathwayAnalysis.applyFilters();
    }

    function sortTable(columnIndex) {
        // Table sorting functionality
        const table = document.getElementById('sites-table');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.rows);

        const isNumeric = (str) => !isNaN(str) && !isNaN(parseFloat(str));

        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();

            if (isNumeric(aValue) && isNumeric(bValue)) {
                return parseFloat(bValue) - parseFloat(aValue);
            }
            return aValue.localeCompare(bValue);
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    // Initialize analysis when page loads
    document.addEventListener('DOMContentLoaded', () => {
        const pathParts = window.location.pathname.split('/');
        const pathwayId = pathParts[2];

        if (pathwayId && !isNaN(pathwayId)) {
            window.pathwayAnalysis = new AdvancedPathwayAnalysis(parseInt(pathwayId));
        } else {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <h3>Invalid Pathway</h3>
                    <p>No valid pathway ID provided</p>
                    <a href="/pathways" class="btn btn-primary">Back to Pathways</a>
                </div>
            `;
        }
    });
</script>
{% endblock %}