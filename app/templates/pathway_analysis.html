<!-- Updated pathway_analysis.html with complete JavaScript -->
{% extends "base.html" %}

{% block title %}{{ pathway_name }} Analysis - KinoPlex{% endblock %}

{% block extra_css %}
<style>
    /* Analysis Layout */
    .analysis-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .analysis-header {
        background: var(--glass-bg);
        border-radius: 20px;
        padding: 3rem;
        margin-bottom: 3rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .pathway-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .pathway-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    /* Interactive Controls */
    .controls-panel {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
    }

    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        align-items: center;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .control-label {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .control-value {
        color: var(--accent-blue);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
    }

    .slider-container {
        position: relative;
    }

    .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent-blue);
        cursor: pointer;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    /* View Switcher */
    .view-switcher {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .view-tab {
        padding: 0.75rem 2rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition-smooth);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .view-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .view-tab.active {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }

    /* Summary Stats */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: var(--transition-smooth);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-elevated);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .chart-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--text-primary);
    }

    /* Protein Cards */
    .proteins-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 2rem;
    }

    .protein-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        transition: var(--transition-smooth);
    }

    .protein-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .protein-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .protein-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .protein-stat {
        text-align: center;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .protein-stat .number {
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Protein Linear View */
    .protein-sequence {
        position: relative;
        height: 150px;
        margin: 2rem 0;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        overflow: hidden;
    }

    .sequence-backbone {
        position: absolute;
        top: 50%;
        left: 5%;
        right: 5%;
        height: 8px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transform: translateY(-50%);
    }

    .phospho-site {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: var(--transition-smooth);
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .phospho-site:hover {
        transform: translateY(-50%) scale(1.8);
        z-index: 10;
    }

    .phospho-site.high-confidence { background: var(--accent-green); }
    .phospho-site.medium-confidence { background: var(--accent-orange); }
    .phospho-site.low-confidence { background: var(--accent-pink); }

    .phospho-site.significant {
        border-width: 3px;
        border-color: var(--accent-blue);
    }

    /* Sites Table */
    .sites-table-container {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        overflow-x: auto;
    }

    .sites-table {
        width: 100%;
        border-collapse: collapse;
    }

    .sites-table th,
    .sites-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .sites-table th {
        background: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .sites-table th:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .sites-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .kinase-scores {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .kinase-score {
        background: var(--gradient-accent);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Kinase Cards */
    .kinases-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    .kinase-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        transition: var(--transition-smooth);
    }

    .kinase-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent-blue);
    }

    .kinase-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 1rem;
    }

    .kinase-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
    }

    .kinase-stat {
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .kinase-stat .number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .kinase-stat .label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }

    /* Site Tooltip */
    .site-tooltip {
        position: absolute;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        max-width: 300px;
    }

    .site-tooltip.visible {
        opacity: 1;
    }

    /* Loading and Empty States */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem;
        color: var(--text-secondary);
    }

    .loading-spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-blue);
        animation: spin 1s ease-in-out infinite;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .proteins-grid {
            grid-template-columns: 1fr;
        }

        .controls-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
        <div class="loading-spinner-large"></div>
        <h3>Analyzing Pathway Phosphoproteome</h3>
        <p>Computing kinase enrichment and site statistics...</p>
    </div>

    <!-- Main Analysis Content -->
    <div id="analysis-content" style="display: none;">
        <!-- Header Section -->
        <div class="analysis-header">
            <div class="pathway-collection-badge" id="pathway-collection"></div>
            <h1 class="pathway-title" id="pathway-title">Pathway Analysis</h1>
            <p class="pathway-subtitle" id="pathway-description"></p>
        </div>

        <!-- Interactive Controls -->
        <div class="controls-panel">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">
                <i class="fas fa-sliders-h"></i> Phosphocompetent Site Filtering
            </h3>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        Probability Threshold
                        <span class="control-value" id="confidence-value">0.5</span>
                    </div>
                    <input type="range" id="confidence-slider" class="slider"
                           min="0" max="1" step="0.01" value="0.5">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        Q-value Threshold
                        <span class="control-value" id="qvalue-value">0.05</span>
                    </div>
                    <input type="range" id="qvalue-slider" class="slider"
                           min="0.001" max="0.2" step="0.001" value="0.05">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        Min Kinase Score
                        <span class="control-value" id="kinase-score-value">0.5</span>
                    </div>
                    <input type="range" id="kinase-score-slider" class="slider"
                           min="0" max="1" step="0.05" value="0.5">
                </div>
                <div class="control-group">
                    <button class="btn btn-primary" onclick="pathwayAnalysis.applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button class="btn btn-secondary" onclick="pathwayAnalysis.resetFilters()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Real-time phosphocompetent stats -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-around; align-items: center;">
                    <div>
                        <strong>Phosphocompetent Sites:</strong>
                        <span id="phosphocompetent-count" style="font-size: 1.5rem; color: var(--accent-blue); margin-left: 0.5rem;">0</span>
                    </div>
                    <div>
                        <strong>S:</strong> <span id="serine-count" style="color: var(--accent-green);">0</span>
                        <strong style="margin-left: 1rem;">T:</strong> <span id="threonine-count" style="color: var(--accent-purple);">0</span>
                        <strong style="margin-left: 1rem;">Y:</strong> <span id="tyrosine-count" style="color: var(--accent-orange);">0</span>
                    </div>
                    <div>
                        <strong>Mean pLDDT:</strong> <span id="mean-plddt">0</span>
                    </div>
                    <div>
                        <strong>Mean SASA:</strong> <span id="mean-sasa">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Switcher -->
        <div class="view-switcher">
            <div class="view-tab active" data-view="overview" onclick="pathwayAnalysis.switchView('overview')">
                <i class="fas fa-chart-pie"></i> Overview
            </div>
            <div class="view-tab" data-view="proteins" onclick="pathwayAnalysis.switchView('proteins')">
                <i class="fas fa-dna"></i> Protein-Level
            </div>
            <div class="view-tab" data-view="sites" onclick="pathwayAnalysis.switchView('sites')">
                <i class="fas fa-dot-circle"></i> Site-Level
            </div>
            <div class="view-tab" data-view="kinases" onclick="pathwayAnalysis.switchView('kinases')">
                <i class="fas fa-cogs"></i> Kinase-Centric
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-stats" id="summary-stats">
            <!-- Stats will be populated here -->
        </div>

        <!-- Overview View -->
        <div class="view-content" id="overview-view">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Confidence Distribution</h3>
                    <canvas id="confidence-chart" height="300"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Residue Type Distribution</h3>
                    <canvas id="residue-chart" height="300"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Secondary Structure Context</h3>
                    <canvas id="structure-chart" height="300"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Top Enriched Kinases</h3>
                    <canvas id="kinase-chart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Protein-Level View -->
        <div class="view-content" id="proteins-view" style="display: none;">
            <div class="proteins-grid" id="proteins-grid">
                <!-- Protein cards will be populated here -->
            </div>
        </div>

        <!-- Site-Level View -->
        <div class="view-content" id="sites-view" style="display: none;">
            <div class="sites-table-container">
                <h3 class="chart-title">All Phosphorylation Sites</h3>
                <table class="sites-table" id="sites-table">
                    <thead>
                        <tr>
                            <th onclick="pathwayAnalysis.sortTable('site_id')">Site ID <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('gene_symbol')">Protein <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('position')">Position <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('residue_type')">Type <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('predicted_prob_calibrated')">Probability <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('qvalue')">Q-value <i class="fas fa-sort"></i></th>
                            <th onclick="pathwayAnalysis.sortTable('secondary_structure')">Structure <i class="fas fa-sort"></i></th>
                            <th>Top 3 Kinases</th>
                        </tr>
                    </thead>
                    <tbody id="sites-table-body">
                        <!-- Sites will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Kinase-Centric View -->
        <div class="view-content" id="kinases-view" style="display: none;">
            <div style="margin-bottom: 2rem;">
                <h3>Kinase Enrichment Analysis</h3>
                <p style="color: var(--text-secondary);">
                    Kinases ranked by number of high-confidence phosphocompetent sites in this pathway
                </p>
            </div>
            <div class="kinases-grid" id="kinases-grid">
                <!-- Kinase cards will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Site Tooltip -->
<div class="site-tooltip" id="site-tooltip"></div>
{% endblock %}

{% block extra_js %}
<script>
    class ComprehensivePathwayAnalysis {
        constructor(pathwayId) {
            this.pathwayId = pathwayId;
            this.analysisData = null;
            this.filteredData = null;
            this.charts = {};
            this.currentView = 'overview';
            this.sortColumn = 'predicted_prob_calibrated';
            this.sortDirection = 'desc';

            this.filters = {
                confidence: 0.5,
                qvalue: 0.05,
                kinaseScore: 0.5
            };

            this.init();
        }

        async init() {
            await this.loadAnalysisData();
            if (this.analysisData) {
                this.setupEventListeners();
                this.applyFilters();
                this.renderAnalysis();
            }
        }

        async loadAnalysisData() {
            try {
                const response = await fetch(`/api/pathway/${this.pathwayId}/analysis`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                this.analysisData = await response.json();

                if (this.analysisData.error) {
                    throw new Error(this.analysisData.error);
                }

                console.log('Analysis data loaded:', this.analysisData);
            } catch (error) {
                console.error('Error loading analysis:', error);
                this.showError(error.message);
            }
        }

        setupEventListeners() {
            // Confidence slider
            const confidenceSlider = document.getElementById('confidence-slider');
            confidenceSlider.addEventListener('input', (e) => {
                document.getElementById('confidence-value').textContent = e.target.value;
                this.filters.confidence = parseFloat(e.target.value);
            });

            // Q-value slider
            const qvalueSlider = document.getElementById('qvalue-slider');
            qvalueSlider.addEventListener('input', (e) => {
                document.getElementById('qvalue-value').textContent = e.target.value;
                this.filters.qvalue = parseFloat(e.target.value);
            });

            // Kinase score slider
            const kinaseScoreSlider = document.getElementById('kinase-score-slider');
            kinaseScoreSlider.addEventListener('input', (e) => {
                document.getElementById('kinase-score-value').textContent = e.target.value;
                this.filters.kinaseScore = parseFloat(e.target.value);
            });
        }

        applyFilters() {
            if (!this.analysisData) return;

            // Filter all sites based on current criteria
            this.filteredData = {
                ...this.analysisData,
                all_sites: this.analysisData.all_sites.filter(site => {
                    const conf = site.predicted_prob_calibrated || 0;
                    const qval = site.qvalue || 1;

                    // Check if site meets phosphocompetent criteria
                    return conf >= this.filters.confidence && qval <= this.filters.qvalue;
                }),
                proteins: this.analysisData.proteins.map(protein => ({
                    ...protein,
                    sites: protein.sites.filter(site => {
                        const conf = site.predicted_prob_calibrated || 0;
                        const qval = site.qvalue || 1;
                        return conf >= this.filters.confidence && qval <= this.filters.qvalue;
                    })
                })).filter(protein => protein.sites.length > 0),
                enriched_kinases: this.analysisData.enriched_kinases.filter(kinase =>
                    kinase.avg_score >= this.filters.kinaseScore
                )
            };

            // Update phosphocompetent statistics
            this.updatePhosphocompetentStats();
            this.updateSummaryStats();
            this.renderCurrentView();
        }

        updatePhosphocompetentStats() {
            const sites = this.filteredData.all_sites;

            // Count phosphocompetent sites by residue type
            let serineCount = 0;
            let threonineCount = 0;
            let tyrosineCount = 0;
            let totalPlddt = 0;
            let pldddtCount = 0;
            let totalSasa = 0;
            let sasaCount = 0;

            sites.forEach(site => {
                if (site.residue_type === 'S') serineCount++;
                else if (site.residue_type === 'T') threonineCount++;
                else if (site.residue_type === 'Y') tyrosineCount++;

                if (site.plddt !== null && site.plddt !== undefined) {
                    totalPlddt += site.plddt;
                    pldddtCount++;
                }

                if (site.sasa_ratio !== null && site.sasa_ratio !== undefined) {
                    totalSasa += site.sasa_ratio;
                    sasaCount++;
                }
            });

            // Update UI
            document.getElementById('phosphocompetent-count').textContent = sites.length;
            document.getElementById('serine-count').textContent = serineCount;
            document.getElementById('threonine-count').textContent = threonineCount;
            document.getElementById('tyrosine-count').textContent = tyrosineCount;
            document.getElementById('mean-plddt').textContent = pldddtCount > 0 ?
                (totalPlddt / pldddtCount).toFixed(1) : '0';
            document.getElementById('mean-sasa').textContent = sasaCount > 0 ?
                (totalSasa / sasaCount).toFixed(3) : '0';
        }

        updateSummaryStats() {
            const sites = this.filteredData.all_sites;
            const proteins = this.filteredData.proteins;
            const kinases = this.filteredData.enriched_kinases;

            // Calculate statistics
            const stats = {
                total_proteins: proteins.length,
                total_sites: sites.length,
                significant_sites: sites.filter(s => s.significant_fdr05).length,
                high_confidence: sites.filter(s => (s.predicted_prob_calibrated || 0) > 0.8).length,
                enriched_kinases: kinases.length,
                avg_confidence: sites.length > 0 ?
                    sites.reduce((sum, s) => sum + (s.predicted_prob_calibrated || 0), 0) / sites.length : 0
            };

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(stats.total_proteins)}</div>
                    <div class="stat-label">Proteins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(stats.total_sites)}</div>
                    <div class="stat-label">Phosphocompetent Sites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(stats.significant_sites)}</div>
                    <div class="stat-label">Significant (FDR<0.05)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(stats.high_confidence)}</div>
                    <div class="stat-label">High Confidence (>0.8)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(stats.enriched_kinases)}</div>
                    <div class="stat-label">Enriched Kinases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(stats.avg_confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
            `;
        }

        renderAnalysis() {
            // Hide loading, show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';

            // Populate header
            this.populateHeader();

            // Render current view
            this.renderCurrentView();
        }

        populateHeader() {
            const { pathway } = this.analysisData;

            document.getElementById('pathway-collection').textContent = pathway.gs_collection;
            document.getElementById('pathway-title').textContent = pathway.gs_name;
            document.getElementById('pathway-description').textContent =
                pathway.gs_description || 'Comprehensive phosphoproteomics analysis';
        }

        switchView(viewName) {
            this.currentView = viewName;

            // Update active tab
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

            // Show/hide view content
            document.querySelectorAll('.view-content').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(`${viewName}-view`).style.display = 'block';

            // Render current view
            this.renderCurrentView();
        }

        renderCurrentView() {
            switch (this.currentView) {
                case 'overview':
                    this.renderOverviewCharts();
                    break;
                case 'proteins':
                    this.renderProteinCards();
                    break;
                case 'sites':
                    this.renderSitesTable();
                    break;
                case 'kinases':
                    this.renderKinasesGrid();
                    break;
            }
        }

        renderOverviewCharts() {
            this.createConfidenceChart();
            this.createResidueChart();
            this.createStructureChart();
            this.createKinaseChart();
        }

        createConfidenceChart() {
            const ctx = document.getElementById('confidence-chart')?.getContext('2d');
            if (!ctx) return;

            const sites = this.filteredData.all_sites;
            const bins = [0, 0, 0, 0, 0];

            sites.forEach(site => {
                const conf = site.predicted_prob_calibrated || 0;
                if (conf < 0.2) bins[0]++;
                else if (conf < 0.4) bins[1]++;
                else if (conf < 0.6) bins[2]++;
                else if (conf < 0.8) bins[3]++;
                else bins[4]++;
            });

            if (this.charts.confidence) {
                this.charts.confidence.destroy();
            }

            this.charts.confidence = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-0.2', '0.2-0.4', '0.4-0.6', '0.6-0.8', '0.8-1.0'],
                    datasets: [{
                        label: 'Site Count',
                        data: bins,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        createResidueChart() {
            const ctx = document.getElementById('residue-chart')?.getContext('2d');
            if (!ctx) return;

            const sites = this.filteredData.all_sites;
            const residueCounts = { S: 0, T: 0, Y: 0 };

            sites.forEach(site => {
                if (site.residue_type in residueCounts) {
                    residueCounts[site.residue_type]++;
                }
            });

            if (this.charts.residue) {
                this.charts.residue.destroy();
            }

            this.charts.residue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Serine (S)', 'Threonine (T)', 'Tyrosine (Y)'],
                    datasets: [{
                        data: [residueCounts.S, residueCounts.T, residueCounts.Y],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        createStructureChart() {
            const ctx = document.getElementById('structure-chart')?.getContext('2d');
            if (!ctx) return;

            const sites = this.filteredData.all_sites;
            const structures = { 'H': 0, 'E': 0, 'C': 0, 'Unknown': 0 };

            sites.forEach(site => {
                const struct = site.secondary_structure || 'Unknown';
                structures[struct] = (structures[struct] || 0) + 1;
            });

            if (this.charts.structure) {
                this.charts.structure.destroy();
            }

            this.charts.structure = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: ['Helix (H)', 'Strand (E)', 'Coil (C)', 'Unknown'],
                    datasets: [{
                        data: [structures.H, structures.E, structures.C, structures.Unknown],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        createKinaseChart() {
            const ctx = document.getElementById('kinase-chart')?.getContext('2d');
            if (!ctx) return;

            const topKinases = this.filteredData.enriched_kinases
                .sort((a, b) => b.phosphocompetent_sites - a.phosphocompetent_sites)
                .slice(0, 10);

            if (this.charts.kinase) {
                this.charts.kinase.destroy();
            }

            this.charts.kinase = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topKinases.map(k => k.kinase),
                    datasets: [{
                        label: 'Phosphocompetent Sites',
                        data: topKinases.map(k => k.phosphocompetent_sites),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        renderProteinCards() {
            const { proteins } = this.filteredData;
            const proteinsGrid = document.getElementById('proteins-grid');

            proteinsGrid.innerHTML = proteins.map(protein => {
                const sites = protein.sites;
                if (sites.length === 0) return '';

                const positions = sites.map(s => s.position).filter(p => p);
                const maxPosition = Math.max(...positions) || 100;
                const minPosition = Math.min(...positions) || 1;

                return `
                    <div class="protein-card">
                        <div class="protein-header">
                            <h3 class="protein-name">${protein.gene_symbol}</h3>
                            <div class="protein-stats">
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(sites.length)}</div>
                                    <div>Phosphocompetent</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(sites.filter(s => s.significant_fdr05).length)}</div>
                                    <div>Significant</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(sites.filter(s => (s.predicted_prob_calibrated || 0) > 0.8).length)}</div>
                                    <div>High Conf.</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${((sites.reduce((sum, s) => sum + (s.predicted_prob_calibrated || 0), 0) / sites.length) * 100).toFixed(0)}%</div>
                                    <div>Avg Conf.</div>
                                </div>
                            </div>
                        </div>

                        <div class="protein-sequence">
                            <div class="sequence-backbone"></div>
                            ${sites.map(site => {
                                const relativePos = ((site.position - minPosition) / (maxPosition - minPosition)) * 90 + 5;
                                const confidence = site.predicted_prob_calibrated || 0;
                                const confidenceClass = confidence > 0.8 ? 'high-confidence' :
                                                      confidence > 0.6 ? 'medium-confidence' : 'low-confidence';
                                const significantClass = site.significant_fdr05 ? 'significant' : '';

                                const topKinases = site.top_kinases || [];
                                const kinaseInfo = topKinases.map(k => `${k.kinase}: ${k.score.toFixed(3)}`).join(', ');

                                return `
                                    <div class="phospho-site ${confidenceClass} ${significantClass}"
                                         style="left: ${relativePos}%"
                                         onmouseover="pathwayAnalysis.showSiteTooltip(event, '${protein.gene_symbol}', ${site.position}, '${site.residue_type}', ${confidence}, '${kinaseInfo}')"
                                         onmouseout="pathwayAnalysis.hideSiteTooltip()">
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Sequence range: ${minPosition} - ${maxPosition}
                        </div>
                    </div>
                `;
            }).join('');
        }

        renderSitesTable() {
            // Sort sites before rendering
            const sites = [...this.filteredData.all_sites];
            sites.sort((a, b) => {
                const aVal = a[this.sortColumn];
                const bVal = b[this.sortColumn];

                if (this.sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            const tbody = document.getElementById('sites-table-body');
            tbody.innerHTML = sites.map(site => `
                <tr>
                    <td><code>${site.site_id}</code></td>
                    <td><strong>${site.gene_symbol}</strong></td>
                    <td>${site.position}</td>
                    <td><span style="font-family: monospace;">${site.residue_type}</span></td>
                    <td>${((site.predicted_prob_calibrated || 0) * 100).toFixed(1)}%</td>
                    <td>${site.qvalue ? site.qvalue.toExponential(2) : 'N/A'}</td>
                    <td>${site.secondary_structure || 'N/A'}</td>
                    <td>
                        <div class="kinase-scores">
                            ${(site.top_kinases || []).slice(0, 3).map(k =>
                                `<div class="kinase-score">${k.kinase}: ${k.score.toFixed(3)}</div>`
                            ).join('') || 'N/A'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        renderKinasesGrid() {
            const kinases = this.filteredData.enriched_kinases
                .sort((a, b) => b.phosphocompetent_sites - a.phosphocompetent_sites);

            const kinasesGrid = document.getElementById('kinases-grid');
            kinasesGrid.innerHTML = kinases.map(kinase => `
                <div class="kinase-card">
                    <div class="kinase-name">${kinase.kinase}</div>
                    <div class="kinase-stats">
                        <div class="kinase-stat">
                            <div class="number">${this.formatNumber(kinase.phosphocompetent_sites)}</div>
                            <div class="label">Phosphocompetent</div>
                        </div>
                        <div class="kinase-stat">
                            <div class="number">${this.formatNumber(kinase.protein_count)}</div>
                            <div class="label">Proteins</div>
                        </div>
                        <div class="kinase-stat">
                            <div class="number">${kinase.avg_score.toFixed(3)}</div>
                            <div class="label">Avg Score</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        sortTable(column) {
            if (this.sortColumn === column) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortColumn = column;
                this.sortDirection = 'desc';
            }
            this.renderSitesTable();
        }

        showSiteTooltip(event, gene, position, residue, confidence, kinases) {
            const tooltip = document.getElementById('site-tooltip');
            tooltip.innerHTML = `
                <strong>${gene} ${residue}${position}</strong><br>
                Confidence: ${(confidence * 100).toFixed(1)}%<br>
                <strong>Top Kinases:</strong><br>
                ${kinases || 'None'}
            `;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('visible');
        }

        hideSiteTooltip() {
            document.getElementById('site-tooltip').classList.remove('visible');
        }

        resetFilters() {
            document.getElementById('confidence-slider').value = '0.5';
            document.getElementById('qvalue-slider').value = '0.05';
            document.getElementById('kinase-score-slider').value = '0.5';

            this.filters = {
                confidence: 0.5,
                qvalue: 0.05,
                kinaseScore: 0.5
            };

            document.getElementById('confidence-value').textContent = '0.5';
            document.getElementById('qvalue-value').textContent = '0.05';
            document.getElementById('kinase-score-value').textContent = '0.5';

            this.applyFilters();
        }

        formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Analysis Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // Initialize analysis when page loads
    let pathwayAnalysis;
    document.addEventListener('DOMContentLoaded', () => {
        const pathParts = window.location.pathname.split('/');
        const pathwayId = pathParts[2];

        if (pathwayId && !isNaN(pathwayId)) {
            window.pathwayAnalysis = new ComprehensivePathwayAnalysis(parseInt(pathwayId));
        } else {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <h3>Invalid Pathway</h3>
                    <p>No valid pathway ID provided</p>
                    <a href="/pathways" class="btn btn-primary">Back to Pathways</a>
                </div>
            `;
        }
    });
</script>
{% endblock %}