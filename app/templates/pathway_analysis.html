{% extends "base.html" %}

{% block title %}{{ pathway_name }} Analysis - KinoPlex{% endblock %}

{% block extra_css %}
<style>
    /* Analysis Layout */
    .analysis-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .analysis-header {
        background: var(--glass-bg);
        border-radius: 20px;
        padding: 3rem;
        margin-bottom: 3rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .analysis-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(600px circle at 30% 20%, rgba(59, 130, 246, 0.1), transparent),
                    radial-gradient(800px circle at 70% 80%, rgba(139, 92, 246, 0.1), transparent);
        pointer-events: none;
    }

    .pathway-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
        color: var(--text-primary);
    }

    .pathway-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 10;
    }

    .pathway-collection-badge {
        background: var(--gradient-primary);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 10;
        display: inline-block;
        margin-bottom: 2rem;
    }

    .analysis-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        position: relative;
        z-index: 10;
    }

    /* View Switcher */
    .view-switcher {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
    }

    .view-tabs {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .view-tab {
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition-smooth);
        font-weight: 500;
        text-align: center;
        flex: 1;
        max-width: 200px;
    }

    .view-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .view-tab.active {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }

    .view-description {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    /* Summary Stats */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--gradient-accent);
        transform: scaleX(0);
        transition: var(--transition-smooth);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-elevated);
    }

    .stat-card:hover::before {
        transform: scaleX(1);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
    }

    .stat-sublabel {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    /* Protein Cards Grid */
    .proteins-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .protein-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .protein-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-elevated);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .protein-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .protein-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .protein-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .protein-stat {
        text-align: center;
    }

    .protein-stat .number {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1rem;
    }

    /* Protein Linear View */
    .protein-sequence {
        position: relative;
        height: 100px;
        margin: 1.5rem 0;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        overflow: hidden;
    }

    .sequence-backbone {
        position: absolute;
        top: 50%;
        left: 5%;
        right: 5%;
        height: 6px;
        background: var(--gradient-secondary);
        border-radius: 3px;
        transform: translateY(-50%);
    }

    .phospho-site {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: var(--transition-smooth);
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        z-index: 5;
    }

    .phospho-site:hover {
        transform: translateY(-50%) scale(1.8);
        z-index: 10;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }

    .phospho-site.high-confidence { background: #10b981; }
    .phospho-site.medium-confidence { background: #f59e0b; }
    .phospho-site.low-confidence { background: #ef4444; }

    .phospho-site.significant {
        border-width: 3px;
        border-color: #3b82f6;
    }

    /* Site Tooltip */
    .site-tooltip {
        position: absolute;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateY(10px);
        transition: var(--transition-smooth);
        min-width: 250px;
    }

    .site-tooltip.active {
        opacity: 1;
        transform: translateY(0);
    }

    .tooltip-header {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-family: 'JetBrains Mono', monospace;
    }

    .tooltip-confidence {
        color: var(--text-secondary);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .tooltip-kinases {
        border-top: 1px solid var(--border-color);
        padding-top: 1rem;
    }

    .tooltip-kinases h4 {
        font-size: 0.875rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .kinase-score {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
    }

    .kinase-name {
        font-family: 'JetBrains Mono', monospace;
        color: var(--text-primary);
    }

    .score-value {
        color: var(--accent-blue);
        font-weight: 600;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .chart-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--text-primary);
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    .chart-container.tall {
        height: 500px;
    }

    /* Kinase Analysis */
    .kinase-analysis {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        margin-bottom: 3rem;
    }

    .kinases-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .kinase-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: var(--transition-smooth);
    }

    .kinase-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--accent-blue);
    }

    .kinase-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .kinase-name-main {
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .kinase-score-main {
        color: var(--accent-blue);
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
    }

    .kinase-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    /* Loading State */
    .analysis-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem;
        color: var(--text-secondary);
    }

    .loading-spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-blue);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 2rem;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .proteins-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .analysis-container {
            padding: 1rem;
        }

        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .analysis-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .protein-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .view-tabs {
            flex-direction: column;
        }

        .kinases-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Loading State -->
    <div id="loading-state" class="analysis-loading">
        <div class="loading-spinner-large"></div>
        <h3>Analyzing Pathway Phosphoproteome</h3>
        <p>Computing kinase enrichment and site statistics...</p>
    </div>

    <!-- Main Analysis Content -->
    <div id="analysis-content" style="display: none;">
        <!-- Header Section -->
        <div class="analysis-header">
            <div class="pathway-collection-badge" id="pathway-collection"></div>
            <h1 class="pathway-title" id="pathway-title">Pathway Analysis</h1>
            <p class="pathway-subtitle" id="pathway-description"></p>

            <div class="analysis-actions">
                <button class="btn btn-primary" onclick="downloadReport()">
                    <i class="fas fa-download"></i>
                    Download Report
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-table"></i>
                    Export Data
                </button>
                <button class="btn btn-secondary" onclick="sharePNG()">
                    <i class="fas fa-image"></i>
                    Save Figures
                </button>
            </div>
        </div>

        <!-- View Switcher -->
        <div class="view-switcher">
            <div class="view-tabs">
                <div class="view-tab active" data-view="overview" onclick="switchView('overview')">
                    <i class="fas fa-chart-pie"></i>
                    <div>Overview</div>
                </div>
                <div class="view-tab" data-view="proteins" onclick="switchView('proteins')">
                    <i class="fas fa-dna"></i>
                    <div>Protein-Level</div>
                </div>
                <div class="view-tab" data-view="sites" onclick="switchView('sites')">
                    <i class="fas fa-dot-circle"></i>
                    <div>Site-Level</div>
                </div>
                <div class="view-tab" data-view="kinases" onclick="switchView('kinases')">
                    <i class="fas fa-cogs"></i>
                    <div>Kinase-Centric</div>
                </div>
            </div>
            <div class="view-description" id="view-description">
                Comprehensive pathway phosphoproteomics analysis with interactive visualizations
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-stats" id="summary-stats">
            <!-- Stats will be populated here -->
        </div>

        <!-- Overview View -->
        <div class="view-content" id="overview-view">
            <div class="charts-grid">
                <!-- Confidence Distribution -->
                <div class="chart-card">
                    <h3 class="chart-title">Phospho-Competency Distribution</h3>
                    <div class="chart-container">
                        <canvas id="confidence-chart"></canvas>
                    </div>
                </div>

                <!-- Residue Type Distribution -->
                <div class="chart-card">
                    <h3 class="chart-title">Residue Type Distribution</h3>
                    <div class="chart-container">
                        <canvas id="residue-chart"></canvas>
                    </div>
                </div>

                <!-- Secondary Structure Distribution -->
                <div class="chart-card">
                    <h3 class="chart-title">Secondary Structure Context</h3>
                    <div class="chart-container">
                        <canvas id="structure-chart"></canvas>
                    </div>
                </div>

                <!-- Top Enriched Kinases -->
                <div class="chart-card">
                    <h3 class="chart-title">Top Enriched Kinases</h3>
                    <div class="chart-container">
                        <canvas id="kinase-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Protein-Level View -->
        <div class="view-content" id="proteins-view" style="display: none;">
            <div class="proteins-grid" id="proteins-grid">
                <!-- Protein cards will be populated here -->
            </div>
        </div>

        <!-- Site-Level View -->
        <div class="view-content" id="sites-view" style="display: none;">
            <div class="chart-card">
                <h3 class="chart-title">All Phosphorylation Sites</h3>
                <div id="sites-table-container">
                    <!-- Sites table will be populated here -->
                </div>
            </div>
        </div>

        <!-- Kinase-Centric View -->
        <div class="view-content" id="kinases-view" style="display: none;">
            <div class="kinase-analysis">
                <h3 class="chart-title">Enriched Kinases Analysis</h3>
                <div class="kinases-grid" id="kinases-grid">
                    <!-- Kinase items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Site Tooltip -->
    <div class="site-tooltip" id="site-tooltip">
        <div class="tooltip-header" id="tooltip-header"></div>
        <div class="tooltip-confidence" id="tooltip-confidence"></div>
        <div class="tooltip-kinases">
            <h4>Top Kinase Predictions</h4>
            <div id="tooltip-kinases-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class PathwayAnalysis {
        constructor(pathwayId) {
            this.pathwayId = pathwayId;
            this.analysisData = null;
            this.charts = {};
            this.currentView = 'overview';

            this.init();
        }

        async init() {
            await this.loadAnalysisData();
            if (this.analysisData) {
                this.renderAnalysis();
            }
        }

        async loadAnalysisData() {
            try {
                const response = await fetch(`/api/pathway/${this.pathwayId}/analysis`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                this.analysisData = await response.json();

                if (this.analysisData.error) {
                    throw new Error(this.analysisData.error);
                }

                console.log('Analysis data loaded:', this.analysisData);
            } catch (error) {
                console.error('Error loading analysis:', error);
                this.showError(error.message);
            }
        }

        renderAnalysis() {
            if (!this.analysisData) return;

            // Hide loading, show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';

            // Populate header
            this.populateHeader();

            // Create summary statistics
            this.createSummaryStats();

            // Render all views
            this.renderOverviewCharts();
            this.renderProteinCards();
            this.renderSitesTable();
            this.renderKinasesGrid();
        }

        populateHeader() {
            const { pathway } = this.analysisData;

            document.getElementById('pathway-collection').textContent = pathway.gs_collection;
            document.getElementById('pathway-title').textContent = pathway.gs_name;
            document.getElementById('pathway-description').textContent =
                pathway.gs_description || 'Comprehensive phosphoproteomics analysis';
        }

        createSummaryStats() {
            const { pathway_stats } = this.analysisData;

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.total_proteins)}</div>
                    <div class="stat-label">Proteins</div>
                    <div class="stat-sublabel">with phospho sites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.total_sites)}</div>
                    <div class="stat-label">Phospho Sites</div>
                    <div class="stat-sublabel">S/T/Y residues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.significant_sites)}</div>
                    <div class="stat-label">Significant</div>
                    <div class="stat-sublabel">FDR < 0.05</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${this.formatNumber(pathway_stats.high_confidence_sites)}</div>
                    <div class="stat-label">High Confidence</div>
                    <div class="stat-sublabel">Prob > 0.8</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(pathway_stats.avg_confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Avg Confidence</div>
                    <div class="stat-sublabel">pathway-wide</div>
                </div>
            `;
        }

        renderOverviewCharts() {
            this.createConfidenceChart();
            this.createResidueChart();
            this.createStructureChart();
            this.createKinaseChart();
        }

        createConfidenceChart() {
            const ctx = document.getElementById('confidence-chart')?.getContext('2d');
            if (!ctx) return;

            const { confidence_distribution } = this.analysisData;

            if (this.charts.confidence) {
                this.charts.confidence.destroy();
            }

            this.charts.confidence = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(confidence_distribution),
                    datasets: [{
                        label: 'Number of Sites',
                        data: Object.values(confidence_distribution),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(34, 197, 94)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        createResidueChart() {
            const ctx = document.getElementById('residue-chart')?.getContext('2d');
            if (!ctx) return;

            const { pathway_stats } = this.analysisData;

            if (this.charts.residue) {
                this.charts.residue.destroy();
            }

            this.charts.residue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Serine', 'Threonine', 'Tyrosine'],
                    datasets: [{
                        data: [pathway_stats.serine_sites, pathway_stats.threonine_sites, pathway_stats.tyrosine_sites],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(236, 72, 153)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b9dc3',
                                font: { family: 'Inter' },
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        createStructureChart() {
            const ctx = document.getElementById('structure-chart')?.getContext('2d');
            if (!ctx) return;

            const { structure_distribution } = this.analysisData;

            const labels = Object.keys(structure_distribution).map(key => {
                const mapping = { 'H': 'Helix', 'E': 'Strand', 'C': 'Coil', 'Unknown': 'Unknown' };
                return mapping[key] || key;
            });

            if (this.charts.structure) {
                this.charts.structure.destroy();
            }

            this.charts.structure = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(structure_distribution),
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderColor: [
                            'rgb(139, 92, 246)',
                            'rgb(236, 72, 153)',
                            'rgb(6, 182, 212)',
                            'rgb(107, 114, 128)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b9dc3',
                                font: { family: 'Inter' },
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        createKinaseChart() {
            const ctx = document.getElementById('kinase-chart')?.getContext('2d');
            if (!ctx) return;

            const { enriched_kinases } = this.analysisData;
            const topKinases = enriched_kinases.slice(0, 10);

            if (this.charts.kinase) {
                this.charts.kinase.destroy();
            }

            this.charts.kinase = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topKinases.map(k => k.kinase),
                    datasets: [{
                        label: 'Average Score',
                        data: topKinases.map(k => k.avg_score),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3', font: { family: 'JetBrains Mono' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3', font: { family: 'JetBrains Mono' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        renderProteinCards() {
            const { proteins } = this.analysisData;
            const proteinsGrid = document.getElementById('proteins-grid');

            proteinsGrid.innerHTML = proteins.map(protein => {
                const maxPosition = protein.stats.max_position || 1000;

                return `
                    <div class="protein-card">
                        <div class="protein-header">
                            <h3 class="protein-name">${protein.gene_symbol}</h3>
                            <div class="protein-stats">
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.stats.total_sites)}</div>
                                    <div>Sites</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.stats.significant_sites)}</div>
                                    <div>Significant</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${this.formatNumber(protein.stats.high_confidence_sites)}</div>
                                    <div>High Conf.</div>
                                </div>
                                <div class="protein-stat">
                                    <div class="number">${(protein.stats.avg_confidence * 100).toFixed(0)}%</div>
                                    <div>Avg Conf.</div>
                                </div>
                            </div>
                        </div>

                        <div class="protein-sequence" id="sequence-${protein.gene_symbol}">
                            <div class="sequence-backbone"></div>
                            ${protein.sites.map((site, index) => {
                                const leftPercent = 5 + (site.position / maxPosition) * 90;
                                const confidence = site.predicted_prob_calibrated || 0;
                                const confidenceClass = confidence > 0.8 ? 'high-confidence' :
                                                      confidence > 0.5 ? 'medium-confidence' : 'low-confidence';
                                const significantClass = site.significant_fdr05 ? 'significant' : '';

                                return `
                                    <div class="phospho-site ${confidenceClass} ${significantClass}"
                                         style="left: ${leftPercent}%"
                                         onmouseenter="pathwayAnalysis.showSiteTooltip(event, '${protein.gene_symbol}', ${index})"
                                         onmouseleave="pathwayAnalysis.hideSiteTooltip()"
                                         onclick="pathwayAnalysis.viewSiteDetail('${site.site_id}')">
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="margin-top: 1rem; text-align: center;">
                            <button class="btn btn-primary btn-sm" onclick="window.open('/protein/${protein.gene_symbol}', '_blank')">
                                <i class="fas fa-external-link-alt"></i>
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        renderSitesTable() {
            const { proteins } = this.analysisData;
            const sitesContainer = document.getElementById('sites-table-container');

            // Flatten all sites from all proteins
            const allSites = [];
            proteins.forEach(protein => {
                protein.sites.forEach(site => {
                    allSites.push({...site, gene_symbol: protein.gene_symbol});
                });
            });

            // Sort by confidence
            allSites.sort((a, b) => (b.predicted_prob_calibrated || 0) - (a.predicted_prob_calibrated || 0));

            sitesContainer.innerHTML = `
                <div style="max-height: 600px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--secondary-bg);">
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="padding: 0.75rem; text-align: left;">Site</th>
                                <th style="padding: 0.75rem; text-align: left;">Gene</th>
                                <th style="padding: 0.75rem; text-align: left;">Position</th>
                                <th style="padding: 0.75rem; text-align: left;">Confidence</th>
                                <th style="padding: 0.75rem; text-align: left;">Significant</th>
                                <th style="padding: 0.75rem; text-align: left;">Structure</th>
                                <th style="padding: 0.75rem; text-align: left;">Top Kinase</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allSites.slice(0, 100).map(site => {
                                const topKinases = this.getTopKinasesForSite(site);
                                return `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;"
                                        onmouseenter="this.style.background='rgba(255,255,255,0.05)'"
                                        onmouseleave="this.style.background='transparent'"
                                        onclick="pathwayAnalysis.viewSiteDetail('${site.site_id}')">
                                        <td style="padding: 0.75rem;">${site.residue_type}${site.position}</td>
                                        <td style="padding: 0.75rem; font-family: 'JetBrains Mono', monospace;">${site.gene_symbol}</td>
                                        <td style="padding: 0.75rem;">${site.position}</td>
                                        <td style="padding: 0.75rem;">${((site.predicted_prob_calibrated || 0) * 100).toFixed(1)}%</td>
                                        <td style="padding: 0.75rem;">${site.significant_fdr05 ? 'Yes' : 'No'}</td>
                                        <td style="padding: 0.75rem;">${site.secondary_structure || 'N/A'}</td>
                                        <td style="padding: 0.75rem;">
                                            ${topKinases.length > 0 ? `${topKinases[0].kinase} (${topKinases[0].score.toFixed(3)})` : 'N/A'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        renderKinasesGrid() {
            const { enriched_kinases } = this.analysisData;
            const kinasesGrid = document.getElementById('kinases-grid');

            kinasesGrid.innerHTML = enriched_kinases.slice(0, 20).map(kinase => `
                <div class="kinase-item">
                    <div class="kinase-header">
                        <div class="kinase-name-main">${kinase.kinase}</div>
                        <div class="kinase-score-main">${kinase.avg_score}</div>
                    </div>
                    <div class="kinase-details">
                        <div><strong>${kinase.site_count}</strong><br>Sites</div>
                        <div><strong>${kinase.protein_count}</strong><br>Proteins</div>
                        <div><strong>${kinase.high_scoring_sites}</strong><br>High Score</div>
                    </div>
                </div>
            `).join('');
        }

        showSiteTooltip(event, proteinName, siteIndex) {
            const tooltip = document.getElementById('site-tooltip');
            const protein = this.analysisData.proteins.find(p => p.gene_symbol === proteinName);
            if (!protein || !protein.sites[siteIndex]) return;

            const site = protein.sites[siteIndex];
            const topKinases = this.getTopKinasesForSite(site).slice(0, 3);

            document.getElementById('tooltip-header').textContent =
                `${site.gene_symbol} ${site.residue_type}${site.position}`;
            document.getElementById('tooltip-confidence').textContent =
                `Confidence: ${((site.predicted_prob_calibrated || 0) * 100).toFixed(1)}% • Q-value: ${site.qvalue ? site.qvalue.toExponential(2) : 'N/A'}`;

            document.getElementById('tooltip-kinases-list').innerHTML = topKinases.map(k => `
                <div class="kinase-score">
                    <span class="kinase-name">${k.kinase}</span>
                    <span class="score-value">${k.score.toFixed(3)}</span>
                </div>
            `).join('');

            // Position tooltip
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY - 10}px`;
            tooltip.classList.add('active');
        }

        hideSiteTooltip() {
            document.getElementById('site-tooltip').classList.remove('active');
        }

        getTopKinasesForSite(site) {
            const kinases = [];
            const kinaseColumns = ['AKT1_MotifScore', 'AKT2_MotifScore', 'AKT3_MotifScore', 'CDK1_MotifScore',
                                 'CDK2_MotifScore', 'CDK4_MotifScore', 'CDK5_MotifScore', 'GSK3A_MotifScore',
                                 'GSK3B_MotifScore', 'ERK1_MotifScore', 'ERK2_MotifScore', 'JNK1_MotifScore',
                                 'JNK2_MotifScore', 'JNK3_MotifScore', 'P38A_MotifScore', 'P38B_MotifScore',
                                 'P38D_MotifScore', 'P38G_MotifScore', 'PKACA_MotifScore', 'PKACB_MotifScore',
                                 'PKACG_MotifScore', 'ROCK1_MotifScore', 'ROCK2_MotifScore', 'MTOR_MotifScore'];

            kinaseColumns.forEach(col => {
                const score = site[col];
                if (score && score > 0) {
                    kinases.push({
                        kinase: col.replace('_MotifScore', ''),
                        score: score
                    });
                }
            });

            return kinases.sort((a, b) => b.score - a.score);
        }

        viewSiteDetail(siteId) {
            // Could open a detailed modal or navigate to site detail page
            console.log('View site detail:', siteId);
        }

        formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Analysis Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // View switching functionality
    function switchView(viewName) {
        // Update active tab
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-view="${viewName}"]`).classList.add('active');

        // Show/hide view content
        document.querySelectorAll('.view-content').forEach(view => {
            view.style.display = 'none';
        });
        document.getElementById(`${viewName}-view`).style.display = 'block';

        // Update description
        const descriptions = {
            overview: 'Comprehensive pathway phosphoproteomics analysis with interactive visualizations',
            proteins: 'Individual protein cards showing phosphorylation site distributions',
            sites: 'Detailed site-level analysis with sortable table view',
            kinases: 'Kinase-centric analysis showing enriched kinases and their targets'
        };
        document.getElementById('view-description').textContent = descriptions[viewName];
    }

    // Export functions
    function downloadReport() {
        alert('PDF report generation would be implemented here');
    }

    function exportData() {
        alert('Excel export would be implemented here');
    }

    function sharePNG() {
        alert('Figure export would be implemented here');
    }

    // Initialize analysis when page loads
    document.addEventListener('DOMContentLoaded', () => {
        const pathParts = window.location.pathname.split('/');
        const pathwayId = pathParts[2];

        if (pathwayId && !isNaN(pathwayId)) {
            window.pathwayAnalysis = new PathwayAnalysis(parseInt(pathwayId));
        } else {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <h3>Invalid Pathway</h3>
                    <p>No valid pathway ID provided</p>
                    <a href="/pathways" class="btn btn-primary">Back to Pathways</a>
                </div>
            `;
        }
    });
</script>
{% endblock %}