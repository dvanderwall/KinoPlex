{% extends "base.html" %}

{% block title %}{{ pathway_name }} Analysis - KinoPlex{% endblock %}

{% block extra_css %}
<style>
    /* Analysis Layout */
    .analysis-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .analysis-header {
        background: var(--glass-bg);
        border-radius: 20px;
        padding: 3rem;
        margin-bottom: 3rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .analysis-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(600px circle at 30% 20%, rgba(59, 130, 246, 0.1), transparent),
                    radial-gradient(800px circle at 70% 80%, rgba(139, 92, 246, 0.1), transparent);
        pointer-events: none;
    }

    .pathway-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        position: relative;
        z-index: 10;
        color: var(--text-primary);
    }

    .pathway-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
        position: relative;
        z-index: 10;
    }

    .pathway-collection-badge {
        background: var(--gradient-primary);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 10;
        display: inline-block;
        margin-bottom: 2rem;
    }

    .analysis-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        position: relative;
        z-index: 10;
    }

    /* Summary Stats */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        text-align: center;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--gradient-accent);
        transform: scaleX(0);
        transition: var(--transition-smooth);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-elevated);
    }

    .stat-card:hover::before {
        transform: scaleX(1);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.875rem;
    }

    .stat-sublabel {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    /* Visualization Grid */
    .viz-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .viz-card {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        position: relative;
    }

    .viz-card.full-width {
        grid-column: 1 / -1;
    }

    .viz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .viz-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .viz-controls {
        display: flex;
        gap: 0.5rem;
    }

    .control-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .control-btn:hover {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    .chart-container.tall {
        height: 500px;
    }

    /* Kinase Enrichment Table */
    .kinase-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
    }

    .kinase-table th,
    .kinase-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .kinase-table th {
        background: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
    }

    .kinase-table td {
        color: var(--text-secondary);
    }

    .kinase-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    .score-cell {
        position: relative;
    }

    .score-bar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        background: rgba(59, 130, 246, 0.2);
        border-radius: 0 4px 4px 0;
        z-index: -1;
    }

    /* Protein Table */
    .protein-table-container {
        max-height: 600px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    .protein-table {
        width: 100%;
        border-collapse: collapse;
    }

    .protein-table th,
    .protein-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .protein-table th {
        background: rgba(255, 255, 255, 0.08);
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .protein-row {
        transition: var(--transition-smooth);
        cursor: pointer;
    }

    .protein-row:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .protein-name {
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .confidence-bar {
        width: 100px;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.25rem;
    }

    .confidence-fill {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    /* Top Kinases List */
    .top-kinases-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .kinase-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .kinase-item:last-child {
        border-bottom: none;
    }

    .kinase-info {
        flex: 1;
    }

    .kinase-name-main {
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .kinase-stats {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .kinase-score-display {
        text-align: right;
        min-width: 60px;
    }

    .score-value {
        font-weight: 700;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Export Controls */
    .export-section {
        background: var(--glass-bg);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid var(--border-color);
        margin-top: 3rem;
    }

    .export-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .export-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-primary);
        text-decoration: none;
        transition: var(--transition-smooth);
        text-align: center;
        justify-content: center;
    }

    .export-btn:hover {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
        transform: translateY(-2px);
    }

    /* Loading State */
    .analysis-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem;
        color: var(--text-secondary);
    }

    .loading-spinner-large {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-blue);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 2rem;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .viz-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .analysis-container {
            padding: 1rem;
        }

        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .analysis-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .protein-table th,
        .protein-table td {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .chart-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Loading State -->
    <div id="loading-state" class="analysis-loading">
        <div class="loading-spinner-large"></div>
        <h3>Analyzing Pathway Phosphoproteome</h3>
        <p>Computing kinase enrichment and site statistics...</p>
    </div>

    <!-- Main Analysis Content -->
    <div id="analysis-content" style="display: none;">
        <!-- Header Section -->
        <div class="analysis-header">
            <div class="pathway-collection-badge" id="pathway-collection"></div>
            <h1 class="pathway-title" id="pathway-title">Pathway Analysis</h1>
            <p class="pathway-subtitle" id="pathway-description"></p>

            <div class="analysis-actions">
                <button class="btn btn-primary" onclick="downloadReport()">
                    <i class="fas fa-download"></i>
                    Download Report
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-table"></i>
                    Export Data
                </button>
                <button class="btn btn-secondary" onclick="sharePNG()">
                    <i class="fas fa-image"></i>
                    Save Figures
                </button>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-stats" id="summary-stats">
            <!-- Stats will be populated here -->
        </div>

        <!-- Main Visualizations -->
        <div class="viz-grid">
            <!-- Confidence Distribution -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Phospho-Competency Distribution</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="downloadChart('confidence-chart')">PNG</button>
                        <button class="control-btn" onclick="downloadChart('confidence-chart', 'svg')">SVG</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="confidence-chart"></canvas>
                </div>
            </div>

            <!-- Residue Type Distribution -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Residue Type Distribution</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="downloadChart('residue-chart')">PNG</button>
                        <button class="control-btn" onclick="downloadChart('residue-chart', 'svg')">SVG</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="residue-chart"></canvas>
                </div>
            </div>

            <!-- Secondary Structure Distribution -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Secondary Structure Context</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="downloadChart('structure-chart')">PNG</button>
                        <button class="control-btn" onclick="downloadChart('structure-chart', 'svg')">SVG</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="structure-chart"></canvas>
                </div>
            </div>

            <!-- Top Enriched Kinases -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Top Enriched Kinases</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="downloadChart('kinase-chart')">PNG</button>
                        <button class="control-btn" onclick="downloadChart('kinase-chart', 'svg')">SVG</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="kinase-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Kinase Enrichment Heatmap -->
        <div class="viz-card full-width">
            <div class="viz-header">
                <h3 class="viz-title">Kinase Enrichment Heatmap</h3>
                <div class="viz-controls">
                    <button class="control-btn" onclick="downloadChart('heatmap')">PNG</button>
                    <button class="control-btn" onclick="downloadChart('heatmap', 'svg')">SVG</button>
                </div>
            </div>
            <div class="chart-container tall">
                <div id="kinase-heatmap"></div>
            </div>
        </div>

        <!-- Detailed Tables Section -->
        <div class="viz-grid">
            <!-- Protein Summary Table -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Protein Summary</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="exportTable('protein-table')">CSV</button>
                    </div>
                </div>
                <div class="protein-table-container">
                    <table class="protein-table" id="protein-table">
                        <thead>
                            <tr>
                                <th>Protein</th>
                                <th>Sites</th>
                                <th>Significant</th>
                                <th>Avg Confidence</th>
                                <th>Top Kinase</th>
                            </tr>
                        </thead>
                        <tbody id="protein-table-body">
                            <!-- Protein rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Kinases List -->
            <div class="viz-card">
                <div class="viz-header">
                    <h3 class="viz-title">Enriched Kinases</h3>
                    <div class="viz-controls">
                        <button class="control-btn" onclick="exportTable('kinase-list')">CSV</button>
                    </div>
                </div>
                <div class="top-kinases-list" id="top-kinases-list">
                    <!-- Kinase items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Export Analysis</h3>
            <div class="export-grid">
                <a href="#" class="export-btn" onclick="downloadFullReport()">
                    <i class="fas fa-file-pdf"></i>
                    Full Report (PDF)
                </a>
                <a href="#" class="export-btn" onclick="exportAllData()">
                    <i class="fas fa-database"></i>
                    All Data (Excel)
                </a>
                <a href="#" class="export-btn" onclick="exportFigures()">
                    <i class="fas fa-images"></i>
                    All Figures (ZIP)
                </a>
                <a href="#" class="export-btn" onclick="exportMethodology()">
                    <i class="fas fa-file-alt"></i>
                    Methods (TXT)
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class PathwayAnalysis {
        constructor(pathwayId) {
            this.pathwayId = pathwayId;
            this.analysisData = null;
            this.charts = {};

            this.init();
        }

        async init() {
            await this.loadAnalysisData();
            this.renderAnalysis();
        }

        async loadAnalysisData() {
            try {
                const response = await fetch(`/api/pathway/${this.pathwayId}/analysis`);
                this.analysisData = await response.json();

                if (!response.ok) {
                    throw new Error(this.analysisData.error || 'Failed to load analysis');
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
                this.showError(error.message);
            }
        }

        renderAnalysis() {
            if (!this.analysisData) return;

            // Hide loading, show content
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';

            // Populate header
            this.populateHeader();

            // Create summary statistics
            this.createSummaryStats();

            // Create all visualizations
            this.createCharts();

            // Populate tables
            this.populateTables();
        }

        populateHeader() {
            const { pathway } = this.analysisData;

            document.getElementById('pathway-collection').textContent = pathway.gs_collection;
            document.getElementById('pathway-title').textContent = pathway.gs_name;
            document.getElementById('pathway-description').textContent =
                pathway.gs_description || 'Comprehensive phosphoproteomics analysis';
        }

        createSummaryStats() {
            const { pathway_stats } = this.analysisData;

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${KinoAPI.formatNumber(pathway_stats.total_proteins)}</div>
                    <div class="stat-label">Proteins</div>
                    <div class="stat-sublabel">with phospho sites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${KinoAPI.formatNumber(pathway_stats.total_sites)}</div>
                    <div class="stat-label">Phospho Sites</div>
                    <div class="stat-sublabel">S/T/Y residues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${KinoAPI.formatNumber(pathway_stats.significant_sites)}</div>
                    <div class="stat-label">Significant</div>
                    <div class="stat-sublabel">FDR &lt; 0.05</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${KinoAPI.formatNumber(pathway_stats.high_confidence_sites)}</div>
                    <div class="stat-label">High Confidence</div>
                    <div class="stat-sublabel">Prob &gt; 0.8</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(pathway_stats.avg_confidence * 100).toFixed(1)}%</div>
                    <div class="stat-label">Avg Confidence</div>
                    <div class="stat-sublabel">pathway-wide</div>
                </div>
            `;
        }

        createCharts() {
            this.createConfidenceChart();
            this.createResidueChart();
            this.createStructureChart();
            this.createKinaseChart();
            this.createKinaseHeatmap();
        }

        createConfidenceChart() {
            const ctx = document.getElementById('confidence-chart').getContext('2d');
            const { confidence_distribution } = this.analysisData;

            this.charts.confidence = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(confidence_distribution),
                    datasets: [{
                        label: 'Number of Sites',
                        data: Object.values(confidence_distribution),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(245, 158, 11)',
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            'rgb(34, 197, 94)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Phospho-Competency Distribution',
                            font: { family: 'Inter', size: 14, weight: '600' },
                            color: '#ffffff'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        createResidueChart() {
            const ctx = document.getElementById('residue-chart').getContext('2d');
            const { pathway_stats } = this.analysisData;

            this.charts.residue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Serine', 'Threonine', 'Tyrosine'],
                    datasets: [{
                        data: [pathway_stats.serine_sites, pathway_stats.threonine_sites, pathway_stats.tyrosine_sites],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)',
                            'rgb(236, 72, 153)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b9dc3',
                                font: { family: 'Inter' },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'Phosphorylatable Residues',
                            font: { family: 'Inter', size: 14, weight: '600' },
                            color: '#ffffff'
                        }
                    }
                }
            });
        }

        createStructureChart() {
            const ctx = document.getElementById('structure-chart').getContext('2d');
            const { structure_distribution } = this.analysisData;

            const labels = Object.keys(structure_distribution).map(key => {
                const mapping = { 'H': 'Helix', 'E': 'Strand', 'C': 'Coil', 'Unknown': 'Unknown' };
                return mapping[key] || key;
            });

            this.charts.structure = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(structure_distribution),
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderColor: [
                            'rgb(139, 92, 246)',
                            'rgb(236, 72, 153)',
                            'rgb(6, 182, 212)',
                            'rgb(107, 114, 128)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b9dc3',
                                font: { family: 'Inter' },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'Secondary Structure Distribution',
                            font: { family: 'Inter', size: 14, weight: '600' },
                            color: '#ffffff'
                        }
                    }
                }
            });
        }

        createKinaseChart() {
            const ctx = document.getElementById('kinase-chart').getContext('2d');
            const { enriched_kinases } = this.analysisData;
            const topKinases = enriched_kinases.slice(0, 10);

            this.charts.kinase = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: topKinases.map(k => k.kinase),
                    datasets: [{
                        label: 'Average Score',
                        data: topKinases.map(k => k.avg_score),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 10 Enriched Kinases',
                            font: { family: 'Inter', size: 14, weight: '600' },
                            color: '#ffffff'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b9dc3', font: { family: 'JetBrains Mono' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#8b9dc3', font: { family: 'JetBrains Mono' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        createKinaseHeatmap() {
            const { enriched_kinases, proteins } = this.analysisData;
            const container = d3.select('#kinase-heatmap');

            // Create heatmap using D3.js for better control
            const margin = { top: 50, right: 150, bottom: 100, left: 150 };
            const width = 800 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            container.selectAll("*").remove();

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Prepare data for heatmap
            const topKinases = enriched_kinases.slice(0, 15).map(k => k.kinase);
            const topProteins = proteins.slice(0, 10).map(p => p.gene_symbol);

            const heatmapData = [];
            topProteins.forEach(protein => {
                const proteinData = proteins.find(p => p.gene_symbol === protein);
                topKinases.forEach(kinase => {
                    const kinaseData = proteinData.top_kinases.find(k => k.kinase === kinase);
                    heatmapData.push({
                        protein: protein,
                        kinase: kinase,
                        score: kinaseData ? kinaseData.avg_score : 0
                    });
                });
            });

            // Scales
            const xScale = d3.scaleBand()
                .domain(topKinases)
                .range([0, width])
                .padding(0.05);

            const yScale = d3.scaleBand()
                .domain(topProteins)
                .range([0, height])
                .padding(0.05);

            const colorScale = d3.scaleSequential()
                .interpolator(d3.interpolateBlues)
                .domain([0, d3.max(heatmapData, d => d.score)]);

            // Create heatmap rectangles
            svg.selectAll('.heatmap-cell')
                .data(heatmapData)
                .enter()
                .append('rect')
                .attr('class', 'heatmap-cell')
                .attr('x', d => xScale(d.kinase))
                .attr('y', d => yScale(d.protein))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.score))
                .attr('stroke', '#1a1d2e')
                .attr('stroke-width', 1);

            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('text-anchor', 'end')
                .style('fill', '#8b9dc3')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-65)');

            svg.append('g')
                .call(d3.axisLeft(yScale))
                .selectAll('text')
                .style('fill', '#8b9dc3');

            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -20)
                .attr('text-anchor', 'middle')
                .style('fill', '#ffffff')
                .style('font-family', 'Inter')
                .style('font-size', '14px')
                .style('font-weight', '600')
                .text('Kinase-Protein Interaction Heatmap');
        }

        populateTables() {
            this.populateProteinTable();
            this.populateKinasesList();
        }

        populateProteinTable() {
            const { proteins } = this.analysisData;
            const tableBody = document.getElementById('protein-table-body');

            tableBody.innerHTML = proteins.map(protein => `
                <tr class="protein-row" onclick="window.open('/protein/${protein.gene_symbol}', '_blank')">
                    <td>
                        <div class="protein-name">${protein.gene_symbol}</div>
                    </td>
                    <td>${protein.stats.total_sites}</td>
                    <td>${protein.stats.significant_sites}</td>
                    <td>
                        <div>${(protein.stats.avg_confidence * 100).toFixed(1)}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${protein.stats.avg_confidence * 100}%"></div>
                        </div>
                    </td>
                    <td>
                        ${protein.top_kinases.length > 0 ?
                          `<span class="kinase-name">${protein.top_kinases[0].kinase}</span><br>
                           <small>(${protein.top_kinases[0].avg_score.toFixed(3)})</small>` :
                          'N/A'
                        }
                    </td>
                </tr>
            `).join('');
        }

        populateKinasesList() {
            const { enriched_kinases } = this.analysisData;
            const kinasesList = document.getElementById('top-kinases-list');

            kinasesList.innerHTML = enriched_kinases.slice(0, 20).map(kinase => `
                <div class="kinase-item">
                    <div class="kinase-info">
                        <div class="kinase-name-main">${kinase.kinase}</div>
                        <div class="kinase-stats">
                            ${kinase.site_count} sites • ${kinase.protein_count} proteins •
                            ${kinase.high_scoring_sites} high-scoring
                        </div>
                    </div>
                    <div class="kinase-score-display">
                        <div class="score-value">${kinase.avg_score}</div>
                    </div>
                </div>
            `).join('');
        }

        showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Analysis Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    // Export functions
    function downloadChart(chartId, format = 'png') {
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const link = document.createElement('a');
            link.download = `${chartId}.${format}`;
            link.href = canvas.toDataURL(`image/${format}`);
            link.click();
        }
    }

    function downloadFullReport() {
        // Implementation for PDF report generation
        alert('PDF report generation would be implemented here');
    }

    function exportAllData() {
        // Implementation for Excel export
        alert('Excel export would be implemented here');
    }

    function exportFigures() {
        // Implementation for ZIP of all figures
        alert('Figure export would be implemented here');
    }

    function exportMethodology() {
        // Export analysis methodology
        const methodology = `
KinoPlex Pathway Phosphoproteomics Analysis

METHODOLOGY:
1. Pathway proteins identified from curated gene sets
2. All S/T/Y phosphorylation sites extracted for pathway proteins
3. Sites ranked by phospho-competency prediction confidence
4. Kinase-substrate predictions computed for 303 human kinases
5. Kinase enrichment calculated across significant sites (FDR < 0.05)
6. Structural context analyzed using AlphaFold2 structures

STATISTICAL METHODS:
- Phospho-competency: Machine learning prediction with confidence calibration
- Significance: False discovery rate (FDR) correction at 5% threshold
- Kinase enrichment: Average scores across significant sites
- Structure analysis: Secondary structure from AlphaFold2 predictions

VISUALIZATION:
- Charts generated with Chart.js and D3.js
- Publication quality: 300 DPI, vector format available
- Color schemes optimized for scientific publication
        `.trim();

        const blob = new Blob([methodology], { type: 'text/plain' });
        const link = document.createElement('a');
        link.download = 'pathway_analysis_methodology.txt';
        link.href = URL.createObjectURL(blob);
        link.click();
    }

    // Initialize analysis when page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Extract pathway ID from URL path: /pathway/{id}/analysis
        const pathParts = window.location.pathname.split('/');
        const pathwayId = pathParts[2]; // pathway ID is the 3rd part (index 2)

        if (pathwayId && !isNaN(pathwayId)) {
            window.pathwayAnalysis = new PathwayAnalysis(parseInt(pathwayId));
        } else {
            document.getElementById('loading-state').innerHTML = `
                <div style="text-align: center; color: var(--accent-pink);">
                    <h3>Invalid Pathway</h3>
                    <p>No valid pathway ID provided</p>
                    <a href="/pathways" class="btn btn-primary">Back to Pathways</a>
                </div>
            `;
        }
    });
</script>
{% endblock %}